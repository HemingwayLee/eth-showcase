{% extends 'base.html' %}

{% block content %}

<div class="container-fluid">
  <div class="row content">
    {% include "sidebar.html" %}
    <div class="col-sm-9 main">
      <div class="row">
        <div id="msg"></div>
        <div class="col-md-4">
          <div class="panel panel-primary"> 
            <div class="panel-body">
              <div style="display:block;"> 
                <i style="font-size: 72px" class="pull-right fas fa-address-card"></i> 
                <h1 id="countAddress"></h1>
                <h4>Address</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="panel panel-primary"> 
            <div class="panel-body">
              <div style="display:block;"> 
                <i style="font-size: 72px" class="pull-right fas fa-file-signature"></i> 
                <h1 id="">85</h1>
                <h4>Smart Contract</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="panel panel-primary"> 
            <div class="panel-body">
              <div style="display:block;"> 
                <i style="font-size: 72px" class="pull-right glyphicon glyphicon-picture"></i> 
                <h1 id="">85</h1>
                <h4>ERC-721 Tokens</h4>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <hr>
        <h2>All Managed Addresses</h2>
        <table id="allAddresses" class="table table-striped">
          <thead>
            <tr>
              <th>Address</th>
              <th>Private</th>
              <th>Created At</th>
              <th>Balance</th>
              <th>Got Balance At</th>
              <th>Get Balance</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  let gAllAddresses = [];
  function getAllAddresses() {
    const urlTarget = window.location.protocol + "//" + window.location.host + '/db/address/all/';
    
    $.ajax({
      type: 'GET',
      dataType: 'json',
      url: urlTarget,
      success: function(data) {
        gAllAddresses = [];
        $("#allAddresses tbody").empty();
        $("#countAddress").text(data.addresses.length);
        
        $.each(data.addresses, function(idx, ele) {
          gAllAddresses.push({"idx": idx, "address": ele.address});

          let tr = $("<tr>");
          tr.append($("<td>").text(ele.address));
          tr.append($("<td>").text(ele.privateKey));
          tr.append($("<td>").text(ele.createdAt));
          tr.append($("<td>").text(ele.balance));
          tr.append($("<td>").text(ele.gotBalanceAt));
          tr.append($("<td>").append($(`<button class="btn btn-primary" onclick="getBalance('${idx}');">`).text("Get Balance")));
          $("#allAddresses tbody").append(tr);
        });
      
      },
      error: function(xhr, textStatus, errorThrown) {
        $('#msg').text(`${textStatus}: [${xhr.status}] ${errorThrown}`);
      },
    });
  }

  function getBalance(idx) {
    // console.log(gAllAddresses.filter(x => x.idx == idx));
    const addr = gAllAddresses.filter(x => x.idx == idx)[0].address;
    const urlTarget = window.location.protocol + "//" + window.location.host + '/eth/balance/' + addr;
    
    $.ajax({
      type: 'GET',
      dataType: 'json',
      url: urlTarget,
      success: function(data) {
        console.log(data);
      },
      error: function(xhr, textStatus, errorThrown) {
        $('#msg').text(`${textStatus}: [${xhr.status}] ${errorThrown}`);
      },
    });
  }

  $(document).ready(function() {
    getAllAddresses();
  });
</script>

{% endblock %}
